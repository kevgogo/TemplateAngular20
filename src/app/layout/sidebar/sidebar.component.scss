/* =====================================
   Sidebar + Flypanel (SCSS completo)
   LINK al sistema de colores (ThemeService / --shell-* / --bs-*)
   ===================================== */

/* ======== Variables (SASS) ======== */
$w-expanded: 224px;
$w-collapsed: 72px;
/* riel conserva border-color del tema */
$rail-color: var(--bs-border-color, rgba(0, 0, 0, 0.15));

/* ======== Tokens CSS del Sidebar (scoped) ======== */
aside.sidebar {
  /* Mapea primero a --shell- si existe; si no, cae a --bs- */
  --sb-bg: var(--shell-sidebar-bg, var(--bs-body-bg, #fff));
  --sb-fg: var(--shell-sidebar-fg, var(--bs-body-color, #212529));
  --sb-border: var(
    --shell-sidebar-border,
    var(--bs-border-color, rgba(0, 0, 0, 0.1))
  );
  --sb-accent: var(--shell-accent, var(--bs-primary, #0d6efd));

  /* Derivados */
  --sb-hover-bg: var(
    --shell-sidebar-hover-bg,
    color-mix(in srgb, var(--sb-bg) 92%, var(--sb-accent) 8%)
  );
  --sb-active-bg: var(
    --shell-sidebar-active-bg,
    color-mix(in srgb, var(--sb-bg) 88%, var(--sb-accent) 12%)
  );
  /* Por defecto el texto activo usa el acento (como tu comportamiento actual) */
  --sb-active-fg: var(--shell-sidebar-active-fg, var(--sb-accent));
  --sb-muted-fg: var(
    --shell-sidebar-muted-fg,
    var(--bs-secondary-color, #6c757d)
  );
  --sb-focus-ring: var(
    --shell-focus-ring,
    color-mix(in srgb, var(--sb-accent) 35%, #fff)
  );

  /* Z-index con fallback */
  --z-sidebar: var(--shell-z-sidebar, 1020);
  --z-sidebar-panel: var(--shell-z-sidebar-panel, 1030);

  width: auto;
}

/* =====================================
   Sidebar base
   ===================================== */
.sidebar {
  position: relative;
  width: $w-expanded;
  height: 100%;
  background: var(--sb-bg);
  color: var(--sb-fg);
  transition: width 0.2s ease;
  overflow: visible;
  z-index: var(--z-sidebar);
  font-size: 13px;

  .root,
  .submenu {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  /* Enlaces comunes */
  .link,
  .sub-link,
  .dropdown-like {
    font-size: 13px;
    line-height: 18px;
    color: inherit;
    text-decoration: none;
    border-radius: 0;
    position: relative;
    transition:
      background-color 0.15s ease,
      color 0.15s ease;
  }
  .link:hover,
  .sub-link:hover,
  .dropdown-like:hover {
    background: var(--sb-hover-bg);
  }

  .link.active,
  .sub-link.active {
    background: var(--sb-active-bg);
    color: var(--sb-active-fg);
    font-weight: 600;
  }
  .link[aria-expanded="true"],
  .sub-link[aria-expanded="true"] {
    color: var(--sb-active-fg);
    font-weight: 600;
  }

  /* Background degradado por niveles - SOLO activos */
  .submenu.depth-1 .sub-link.active {
    background: color-mix(in srgb, var(--sb-accent) 6%, transparent);
  }
  .submenu.depth-2 .sub-link.active {
    background: transparent;
  }

  /* Iconos */
  .link .fa,
  .sub-link .fa,
  .dropdown-like .fa {
    display: inline-block;
    position: relative;
    z-index: 1;
    width: 1.125rem;
    min-width: 1.125rem;
    flex: 0 0 1.125rem;
    line-height: 1;
    color: currentColor;
    text-align: center;
    font-size: 1rem;
  }
  .fa::before {
    display: inline-block;
    vertical-align: -0.125em;
  }
  .fa.ms-auto {
    opacity: 0.7;
    transition:
      transform 0.15s ease,
      opacity 0.15s ease;
  }
  .link[aria-expanded="true"] .ms-auto,
  .sub-link[aria-expanded="true"] .ms-auto {
    opacity: 1;
  }

  /* ===== Expandido ===== */
  &:not(.collapsed) {
    .submenu {
      margin: 0.25rem 0;
    }

    /* Riel vertical por profundidad */
    .submenu.depth-1,
    .submenu.depth-2,
    .submenu.depth-3,
    .submenu.depth-4,
    .submenu.depth-5 {
      position: relative;
      &::before {
        content: "";
        position: absolute;
        left: 0.5rem;
        top: 0.5rem;
        bottom: 0.5rem;
        width: 1px;
        background: $rail-color;
        pointer-events: none;
      }
    }

    /* Sangrías */
    .submenu.depth-1 {
      padding-left: 0.75rem;
    }
    .submenu.depth-2,
    .submenu.depth-3 {
      padding-left: 0.5rem;
      margin-left: 0.25rem;
    }

    /* Atenuar riel con profundidad */
    .submenu.depth-1::before {
      opacity: 0.55;
    }
    .submenu.depth-2::before {
      opacity: 0.4;
    }
    .submenu.depth-3::before {
      opacity: 0.28;
    }
    .submenu.depth-4::before {
      opacity: 0.2;
    }

    /* Sin bordes para TODOS los hijos */
    .submenu .sub-link,
    .submenu .subitem.has-children:not(.open) > .sub-link {
      background: transparent;
      border: 0;
      border-radius: 0;
    }

    /* ===== Barra de acento SOLO en nodos con hijos y EXPANDIDOS ===== */
    .link::before,
    .sub-link::before {
      content: none;
    }

    /* Nivel 0 */
    .item.has-children.open > .link,
    .item.has-children > .link[aria-expanded="true"] {
      position: relative;
      &::before {
        content: "";
        position: absolute;
        left: 0.25rem;
        top: 6px;
        bottom: 6px;
        width: 4px;
        border-radius: 4px;
        background: var(--sb-accent);
        pointer-events: none;
        z-index: 0;
      }
    }

    /* Niveles hijos */
    .subitem.has-children.open > .sub-link,
    .subitem.has-children > .sub-link[aria-expanded="true"] {
      position: relative;
      &::before {
        content: "";
        position: absolute;
        left: 0.25rem;
        top: 6px;
        bottom: 6px;
        width: 4px;
        border-radius: 4px;
        background: var(--sb-accent);
        pointer-events: none;
        z-index: 0;
      }
    }

    /* Chevrons sutiles */
    .submenu .subitem.has-children .ms-auto {
      opacity: 0.6;
    }
    .submenu .subitem.has-children.open .ms-auto {
      opacity: 0.9;
    }

    /* Hover leve niveles altos */
    .submenu.depth-3 .sub-link:hover,
    .submenu.depth-4 .sub-link:hover {
      background: color-mix(in srgb, var(--sb-bg) 96%, #000 4%);
    }
  }

  /* ===== Colapsado ===== */
  &.collapsed {
    width: $w-collapsed;

    .item {
      position: relative;
    }
    .link {
      justify-content: center;
      gap: 0;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
      position: relative;
    }

    .chevron-collapsed {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.75;
      pointer-events: none;
      font-size: 1rem;
    }
    .item:hover .chevron-collapsed {
      opacity: 1;
    }

    /* Nunca mostrar barras en modo colapsado */
    .link::before,
    .sub-link::before {
      content: none !important;
    }
  }

  /* Quitar cualquier ::after de <a> */
  .link::after,
  .sub-link::after,
  .dropdown-like::after,
  a::after {
    content: none !important;
  }

  /* Alto de filas de nivel 0 */
  .root > .item a {
    height: 50px;
  }

  /* Accesibilidad */
  a:focus-visible {
    outline: 2px solid var(--sb-focus-ring);
    outline-offset: 2px;
    border-radius: 0;
  }
}

/* =====================================
   Panel Único (colapsado)
   ===================================== */
.flypanel-backdrop {
  position: fixed;
  inset: 0;
  background: transparent;
  z-index: calc(var(--z-sidebar-panel) - 1);
}
.flypanel {
  position: fixed;
  min-width: 260px;
  max-width: 360px;
  max-height: calc(100vh - 24px);
  /* SIN overflow aquí: el scroll va en .panel-scroll */
  background: var(--sb-bg);
  border: 1px solid var(--sb-border);
  border-radius: 0.5rem;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  z-index: var(--z-sidebar-panel);
}
.flypanel-header {
  display: flex;
  align-items: center;
  border-bottom: 1px solid var(--sb-border);
  .title {
    line-height: 1.25rem;
    font-size: 13px;
  }
  .btn {
    color: inherit;
  }
}
.panel-list {
  list-style: none;
  margin: 0;
  padding: 0.25rem 0;
  .panel-item .dropdown-like {
    border-radius: 0;
  }
  .panel-item:first-child .dropdown-like {
    padding-top: 0.5rem;
  }
  .panel-item:last-child .dropdown-like {
    padding-bottom: 0.5rem;
  }
}

/* Ocultar cuando layout colapsa por servicio externo */
:host-context(.sidebar-collapsed) .hide-when-sidebar-collapsed {
  display: none !important;
}

/* Buscador (sidebar expandida) */
.search-container {
  height: 50px;
}
.sidebar .item.meta .link {
  pointer-events: none;
  cursor: default;
}
.sidebar .item.meta .link:hover {
  background: inherit;
}
.sidebar .search-term {
  background: var(--bs-warning-bg-subtle, #fff3cd);
  padding: 0.05rem 0.25rem;
  border-radius: 0.2rem;
}
.search-area {
  height: 50px;
}

/* ===== Lupa en modo colapsado (estilo permanente activo) ===== */
.collapsed-search {
  padding: 0;
  border-bottom: 1px solid var(--sb-border);
  .link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    height: 50px;
    width: 100%;
    padding: 0 1rem;
    background: transparent;
    border: 0;
    border-radius: 0;
    color: var(--sb-fg);
    text-decoration: none;
    &:hover {
      background: var(--sb-hover-bg);
      color: var(--sb-fg);
    }
    .fa {
      width: 1.125rem;
      min-width: 1.125rem;
      text-align: center;
    }
  }
}
aside.sidebar .collapsed-search {
  background: transparent !important;
}
aside.sidebar .collapsed-search:hover {
  background: transparent !important;
}
aside.sidebar .collapsed-search .link.active-static {
  background: var(--sb-active-bg) !important;
  color: var(--sb-active-fg) !important;
  box-shadow: none !important;
  outline: 0 !important;
}
aside.sidebar .collapsed-search .link.active-static:hover,
aside.sidebar .collapsed-search:hover .link.active-static,
aside.sidebar .collapsed-search .link.active-static:focus,
aside.sidebar .collapsed-search .link.active-static:active {
  background: var(--sb-active-bg) !important;
  color: var(--sb-active-fg) !important;
  text-decoration: none !important;
  box-shadow: none !important;
  outline: 0 !important;
}
aside.sidebar .collapsed-search .link {
  height: 50px;
}

/* =====================================
   Flypanel de búsqueda: scroll interno
   ===================================== */
/* Scrollbar delgada sólo DENTRO del contenedor scrolleable del panel */
.flypanel .panel-scroll {
  scrollbar-width: thin; /* Firefox */
  scrollbar-color: color-mix(in srgb, var(--sb-accent) 25%, #999) transparent;
}
.flypanel .panel-scroll::-webkit-scrollbar {
  width: 8px;
}
.flypanel .panel-scroll::-webkit-scrollbar-track {
  background: transparent;
}
.flypanel .panel-scroll::-webkit-scrollbar-thumb {
  background-color: color-mix(in srgb, var(--sb-accent) 35%, #aaa);
  border-radius: 6px;
  border: 2px solid transparent;
}
.flypanel .panel-scroll::-webkit-scrollbar-thumb:hover {
  background-color: color-mix(in srgb, var(--sb-accent) 55%, #888);
}

/* El body del panel no scrollea; el scroll vive en .panel-scroll */
.flypanel .panel-body {
  overflow: visible;
}

/* Altura del área scrolleable calculada (no afecta a otros flypanels) */
.flypanel .panel-scroll {
  --fp-safe: 24px; /* márgenes externos del panel */
  --fp-header: 44px; /* alto aprox. del header */
  --fp-search: 40px; /* alto aprox. del input + paddings */
  --fp-footer: 68px; /* alto del footer (meta + botones) */

  max-height: calc(
    60vh - var(--fp-safe) - var(--fp-header) - var(--fp-search) - var(
        --fp-footer
      )
  );
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

/* Footer centrado y fijo al fondo del panel */
.flypanel .panel-footer.center {
  position: sticky;
  bottom: 0;
  z-index: 2;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  text-align: center;
  padding: 0.5rem 0.75rem;
  background: var(--sb-bg);
  border-top: 1px solid var(--sb-border);
  padding-bottom: calc(0.5rem + env(safe-area-inset-bottom, 0));
}
.flypanel .panel-footer.center .actions {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  flex-wrap: wrap;
}

/* =========================
   Flypanel: modo compacto (opcional)
   ========================= */
.flypanel.compact {
  .flypanel-header {
    min-height: 36px;
    padding-top: 0.25rem !important;
    padding-bottom: 0.25rem !important;
    .title {
      font-size: 0.875rem;
      line-height: 1.15;
    }
    .btn {
      padding: 0 0.25rem !important;
      line-height: 1;
    }
  }
  .form-control.form-control-sm {
    height: 28px;
    padding: 0.15rem 0.5rem;
    font-size: 0.8125rem;
    line-height: 1.1;
  }
  .panel-list {
    padding: 0.25rem 0;
  }
  .panel-item {
    margin: 0;
  }
  .dropdown-like {
    padding: 0.375rem 0.75rem;
    gap: 0.5rem;
    font-size: 0.8125rem;
    line-height: 1.15;
  }
  .fa {
    font-size: 0.95rem;
    width: 1rem;
    min-width: 1rem;
    text-align: center;
  }
  .search-highlight {
    padding: 0 0.1rem;
    background: color-mix(
      in srgb,
      var(--bs-warning-bg-subtle, #fff3cd) 70%,
      transparent
    );
  }
}
.flypanel.compact.hide-icons .fa {
  display: none;
}
/* =========================
   Flypanel: unificar color de botones
   ========================= */
.flypanel .panel-footer.center .btn {
  /* Usa el acento del sidebar (→ shell-accent → bs-primary) */
  --bs-btn-color: #fff;
  --bs-btn-bg: var(--sb-accent);
  --bs-btn-border-color: var(--sb-accent);

  --bs-btn-hover-color: #fff;
  --bs-btn-hover-bg: color-mix(in srgb, var(--sb-accent) 92%, #000 8%);
  --bs-btn-hover-border-color: color-mix(
    in srgb,
    var(--sb-accent) 90%,
    #000 10%
  );

  --bs-btn-active-color: #fff;
  --bs-btn-active-bg: color-mix(in srgb, var(--sb-accent) 82%, #000 18%);
  --bs-btn-active-border-color: color-mix(
    in srgb,
    var(--sb-accent) 80%,
    #000 20%
  );

  --bs-btn-disabled-color: #fff;
  --bs-btn-disabled-bg: color-mix(in srgb, var(--sb-accent) 60%, #bbb 40%);
  --bs-btn-disabled-border-color: var(--bs-btn-disabled-bg);

  /* opcional: micro-ajustes de tamaño/forma */
  --bs-btn-padding-x: 0.9rem;
  --bs-btn-padding-y: 0.45rem;
  --bs-btn-border-radius: 9999px; /* pastilla */
}

/* Si quieres que el focus use tu ring del tema */
.flypanel .panel-footer.center .btn:focus-visible {
  box-shadow: 0 0 0 0.2rem var(--sb-focus-ring);
}
